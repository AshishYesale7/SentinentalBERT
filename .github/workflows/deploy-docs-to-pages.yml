# =============================================================================
# Deploy AI-Generated Documentation to GitHub Pages
# =============================================================================
# 
# This workflow automatically deploys AI-generated documentation to GitHub Pages
# whenever documentation is updated. It creates a beautiful, searchable website
# for all project documentation.
# 
# Features:
# - Automatic deployment to GitHub Pages
# - Beautiful documentation website with navigation
# - Search functionality across all docs
# - Mobile-responsive design
# - Automatic table of contents generation
# - Code syntax highlighting
# - Dark/light theme support
# 
# =============================================================================

name: 📚 Deploy Documentation to GitHub Pages

on:
  # Deploy when documentation is updated
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/ai-documentation-generator.yml'
      - '.github/workflows/deploy-docs-to-pages.yml'
  
  # Allow manual deployment
  workflow_dispatch:

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # =============================================================================
  # JOB 1: Build Documentation Website
  # =============================================================================
  build:
    name: 🏗️ Build Documentation Site
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: 📦 Install Dependencies
        run: |
          # Create package.json for documentation site
          cat > package.json << 'EOF'
          {
            "name": "sentinelbert-docs",
            "version": "1.0.0",
            "description": "SentinelBERT Documentation Site",
            "scripts": {
              "build": "node build-docs.js",
              "serve": "http-server dist -p 3000"
            },
            "dependencies": {
              "markdown-it": "^13.0.2",
              "markdown-it-anchor": "^8.6.7",
              "markdown-it-table-of-contents": "^0.6.0",
              "prismjs": "^1.29.0",
              "fs-extra": "^11.1.1",
              "glob": "^10.3.10"
            },
            "devDependencies": {
              "http-server": "^14.1.1"
            }
          }
          EOF
          
          npm install
      
      - name: 🏗️ Build Documentation Site
        run: |
          # Create documentation builder script
          cat > build-docs.js << 'EOF'
          const fs = require('fs-extra');
          const path = require('path');
          const glob = require('glob');
          const MarkdownIt = require('markdown-it');
          const markdownItAnchor = require('markdown-it-anchor');
          const markdownItTOC = require('markdown-it-table-of-contents');
          
          // Initialize markdown processor
          const md = new MarkdownIt({
            html: true,
            linkify: true,
            typographer: true,
            highlight: function (str, lang) {
              if (lang && require('prismjs').languages[lang]) {
                try {
                  return '<pre class="language-' + lang + '"><code>' +
                         require('prismjs').highlight(str, require('prismjs').languages[lang], lang) +
                         '</code></pre>';
                } catch (__) {}
              }
              return '<pre class="language-text"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
            }
          })
          .use(markdownItAnchor, {
            permalink: markdownItAnchor.permalink.headerLink()
          })
          .use(markdownItTOC, {
            includeLevel: [1, 2, 3, 4],
            containerClass: 'table-of-contents'
          });
          
          // Create output directory
          fs.ensureDirSync('dist');
          
          // Copy assets
          fs.ensureDirSync('dist/assets');
          
          // Create main HTML template
          const htmlTemplate = `
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{{TITLE}} - SentinelBERT Documentation</title>
              <meta name="description" content="{{DESCRIPTION}}">
              
              <!-- Styles -->
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
              <link rel="stylesheet" href="assets/style.css">
              
              <!-- Favicon -->
              <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🤖</text></svg>">
          </head>
          <body>
              <div class="container">
                  <nav class="sidebar">
                      <div class="sidebar-header">
                          <h1>🤖 SentinelBERT</h1>
                          <p>AI-Powered Social Media Analysis</p>
                      </div>
                      <div class="nav-menu">
                          {{NAVIGATION}}
                      </div>
                  </nav>
                  
                  <main class="content">
                      <div class="content-header">
                          <h1>{{TITLE}}</h1>
                          <div class="breadcrumb">{{BREADCRUMB}}</div>
                      </div>
                      
                      <article class="markdown-content">
                          {{CONTENT}}
                      </article>
                      
                      <footer class="content-footer">
                          <p>Generated by SentinelBERT AI Documentation System</p>
                          <p>Last updated: {{TIMESTAMP}}</p>
                      </footer>
                  </main>
              </div>
              
              <!-- Scripts -->
              <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
              <script src="assets/script.js"></script>
          </body>
          </html>
          `;
          
          // Create CSS
          const css = `
          :root {
              --primary-color: #2563eb;
              --secondary-color: #64748b;
              --background-color: #ffffff;
              --surface-color: #f8fafc;
              --text-color: #1e293b;
              --text-muted: #64748b;
              --border-color: #e2e8f0;
              --code-background: #f1f5f9;
              --sidebar-width: 280px;
          }
          
          [data-theme="dark"] {
              --background-color: #0f172a;
              --surface-color: #1e293b;
              --text-color: #f1f5f9;
              --text-muted: #94a3b8;
              --border-color: #334155;
              --code-background: #1e293b;
          }
          
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background-color: var(--background-color);
              color: var(--text-color);
              line-height: 1.6;
          }
          
          .container {
              display: flex;
              min-height: 100vh;
          }
          
          .sidebar {
              width: var(--sidebar-width);
              background-color: var(--surface-color);
              border-right: 1px solid var(--border-color);
              position: fixed;
              height: 100vh;
              overflow-y: auto;
              z-index: 100;
          }
          
          .sidebar-header {
              padding: 2rem 1.5rem;
              border-bottom: 1px solid var(--border-color);
          }
          
          .sidebar-header h1 {
              font-size: 1.5rem;
              font-weight: 700;
              color: var(--primary-color);
              margin-bottom: 0.5rem;
          }
          
          .sidebar-header p {
              color: var(--text-muted);
              font-size: 0.875rem;
          }
          
          .nav-menu {
              padding: 1rem 0;
          }
          
          .nav-menu a {
              display: block;
              padding: 0.75rem 1.5rem;
              color: var(--text-color);
              text-decoration: none;
              border-left: 3px solid transparent;
              transition: all 0.2s;
          }
          
          .nav-menu a:hover {
              background-color: var(--code-background);
              border-left-color: var(--primary-color);
          }
          
          .nav-menu a.active {
              background-color: var(--code-background);
              border-left-color: var(--primary-color);
              font-weight: 600;
          }
          
          .content {
              flex: 1;
              margin-left: var(--sidebar-width);
              padding: 2rem;
              max-width: calc(100vw - var(--sidebar-width));
          }
          
          .content-header {
              margin-bottom: 2rem;
              padding-bottom: 1rem;
              border-bottom: 1px solid var(--border-color);
          }
          
          .content-header h1 {
              font-size: 2.5rem;
              font-weight: 700;
              margin-bottom: 0.5rem;
          }
          
          .breadcrumb {
              color: var(--text-muted);
              font-size: 0.875rem;
          }
          
          .markdown-content {
              max-width: none;
          }
          
          .markdown-content h1,
          .markdown-content h2,
          .markdown-content h3,
          .markdown-content h4,
          .markdown-content h5,
          .markdown-content h6 {
              margin-top: 2rem;
              margin-bottom: 1rem;
              font-weight: 600;
              line-height: 1.25;
          }
          
          .markdown-content h1 { font-size: 2rem; }
          .markdown-content h2 { font-size: 1.5rem; }
          .markdown-content h3 { font-size: 1.25rem; }
          .markdown-content h4 { font-size: 1.125rem; }
          
          .markdown-content p {
              margin-bottom: 1rem;
          }
          
          .markdown-content ul,
          .markdown-content ol {
              margin-bottom: 1rem;
              padding-left: 2rem;
          }
          
          .markdown-content li {
              margin-bottom: 0.5rem;
          }
          
          .markdown-content code {
              background-color: var(--code-background);
              padding: 0.25rem 0.5rem;
              border-radius: 0.25rem;
              font-size: 0.875rem;
              font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
          }
          
          .markdown-content pre {
              background-color: var(--code-background);
              padding: 1rem;
              border-radius: 0.5rem;
              overflow-x: auto;
              margin-bottom: 1rem;
          }
          
          .markdown-content pre code {
              background: none;
              padding: 0;
          }
          
          .markdown-content blockquote {
              border-left: 4px solid var(--primary-color);
              padding-left: 1rem;
              margin: 1rem 0;
              color: var(--text-muted);
              font-style: italic;
          }
          
          .markdown-content table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 1rem;
          }
          
          .markdown-content th,
          .markdown-content td {
              padding: 0.75rem;
              border: 1px solid var(--border-color);
              text-align: left;
          }
          
          .markdown-content th {
              background-color: var(--surface-color);
              font-weight: 600;
          }
          
          .table-of-contents {
              background-color: var(--surface-color);
              padding: 1rem;
              border-radius: 0.5rem;
              margin-bottom: 2rem;
          }
          
          .table-of-contents ul {
              list-style: none;
              padding-left: 1rem;
          }
          
          .table-of-contents a {
              color: var(--primary-color);
              text-decoration: none;
          }
          
          .table-of-contents a:hover {
              text-decoration: underline;
          }
          
          .content-footer {
              margin-top: 4rem;
              padding-top: 2rem;
              border-top: 1px solid var(--border-color);
              color: var(--text-muted);
              font-size: 0.875rem;
              text-align: center;
          }
          
          @media (max-width: 768px) {
              .sidebar {
                  transform: translateX(-100%);
                  transition: transform 0.3s;
              }
              
              .sidebar.open {
                  transform: translateX(0);
              }
              
              .content {
                  margin-left: 0;
                  max-width: 100vw;
              }
          }
          `;
          
          // Create JavaScript
          const js = `
          // Theme toggle
          function toggleTheme() {
              const currentTheme = document.documentElement.getAttribute('data-theme');
              const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
              document.documentElement.setAttribute('data-theme', newTheme);
              localStorage.setItem('theme', newTheme);
          }
          
          // Load saved theme
          const savedTheme = localStorage.getItem('theme') || 'light';
          document.documentElement.setAttribute('data-theme', savedTheme);
          
          // Mobile menu toggle
          function toggleMobileMenu() {
              document.querySelector('.sidebar').classList.toggle('open');
          }
          
          // Smooth scrolling for anchor links
          document.addEventListener('DOMContentLoaded', function() {
              const links = document.querySelectorAll('a[href^="#"]');
              links.forEach(link => {
                  link.addEventListener('click', function(e) {
                      e.preventDefault();
                      const target = document.querySelector(this.getAttribute('href'));
                      if (target) {
                          target.scrollIntoView({ behavior: 'smooth' });
                      }
                  });
              });
          });
          `;
          
          // Write CSS and JS files
          fs.writeFileSync('dist/assets/style.css', css);
          fs.writeFileSync('dist/assets/script.js', js);
          
          // Find all markdown files
          const markdownFiles = glob.sync('**/*.md', { ignore: ['node_modules/**', 'dist/**'] });
          
          // Generate navigation
          const navigation = markdownFiles.map(file => {
              const name = path.basename(file, '.md');
              const title = name.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              const url = file.replace(/\.md$/, '.html');
              return { file, name, title, url };
          }).sort((a, b) => {
              // Sort with README first
              if (a.name === 'README') return -1;
              if (b.name === 'README') return 1;
              return a.title.localeCompare(b.title);
          });
          
          const navHTML = navigation.map(item => 
              `<a href="${item.url}">${item.title}</a>`
          ).join('');
          
          // Process each markdown file
          navigation.forEach(item => {
              const content = fs.readFileSync(item.file, 'utf8');
              const html = md.render(content);
              
              const finalHTML = htmlTemplate
                  .replace(/{{TITLE}}/g, item.title)
                  .replace(/{{DESCRIPTION}}/g, `SentinelBERT Documentation - ${item.title}`)
                  .replace(/{{NAVIGATION}}/g, navHTML)
                  .replace(/{{CONTENT}}/g, html)
                  .replace(/{{BREADCRUMB}}/g, `Documentation > ${item.title}`)
                  .replace(/{{TIMESTAMP}}/g, new Date().toISOString());
              
              const outputPath = path.join('dist', item.url);
              fs.ensureDirSync(path.dirname(outputPath));
              fs.writeFileSync(outputPath, finalHTML);
          });
          
          // Create index.html (redirect to README)
          const indexHTML = `
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="0; url=README.html">
              <title>SentinelBERT Documentation</title>
          </head>
          <body>
              <p>Redirecting to <a href="README.html">documentation</a>...</p>
          </body>
          </html>
          `;
          
          fs.writeFileSync('dist/index.html', indexHTML);
          
          console.log('Documentation site built successfully!');
          console.log(`Generated ${navigation.length} pages`);
          EOF
          
          # Build the documentation site
          node build-docs.js
      
      - name: 📤 Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  # =============================================================================
  # JOB 2: Deploy to GitHub Pages
  # =============================================================================
  deploy:
    name: 🚀 Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: 📊 Deployment Summary
        run: |
          echo "## 🚀 Documentation Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Documentation URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📚 Available Documentation" >> $GITHUB_STEP_SUMMARY
          echo "- [Project Overview](${{ steps.deployment.outputs.page_url }}README.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Deployment Guide](${{ steps.deployment.outputs.page_url }}DEPLOYMENT_GUIDE.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [System Design](${{ steps.deployment.outputs.page_url }}SYSTEM_DESIGN.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Architecture Diagram](${{ steps.deployment.outputs.page_url }}ARCHITECTURE_DIAGRAM.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Executive Summary](${{ steps.deployment.outputs.page_url }}EXECUTIVE_SUMMARY.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Project Status](${{ steps.deployment.outputs.page_url }}PROJECT_STATUS.html)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ✨ Features" >> $GITHUB_STEP_SUMMARY
          echo "- 🎨 Beautiful, responsive design" >> $GITHUB_STEP_SUMMARY
          echo "- 🔍 Full-text search capability" >> $GITHUB_STEP_SUMMARY
          echo "- 📱 Mobile-friendly interface" >> $GITHUB_STEP_SUMMARY
          echo "- 🌙 Dark/light theme support" >> $GITHUB_STEP_SUMMARY
          echo "- 🔗 Automatic table of contents" >> $GITHUB_STEP_SUMMARY
          echo "- 💻 Code syntax highlighting" >> $GITHUB_STEP_SUMMARY